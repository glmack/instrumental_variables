setwd('/Users/lee/Documents/code/instrumental_variables')
install.packages('AER')
library('AER')
data("CigarettesSW", package="AER")
CigarettesSW$rprice <- with(CigarettesSW, price/cpi)
CigarettesSW$rincome <- with(CigarettesSW, income/population/cpi)
CigarettesSWtdiff <- with(CigarettesSW, (taxs - tax)/cpi)

# model
fm <- ivreg(log(packs) ~ log(rprice) + log(rincome) | log(rincome + tdiff + I(tax/cpi), data = CigarettesSW, subset = year == "1995")

summary(fm)
summary(fm, vcov = sandwich, df = Inf, diagnostics = TRUE)

# ANOVA
fm2 <- ivreg(log(packs) - log(rprice) | tdiff, data = CigarettesSW, subset = year == "1995")
anova(fm, fm2)


# -----------------------
library(AER)

# load panel data set from 1976
data("PSID1976")

# summarize data set
summary(PSID1976)

# family background variables, such as father's education ('feducation') and mother's education ('meducation') are
# possible candidates for IVs

# regress log of wage on education, produces error
model1 <- lm(log(wage) ~ education, data = PSID1976)

#
model2 <- lm(log(wage) ~ education, data = subset(PSID1976, participation=="yes"]

summary(model2)

plot(PSID1976$education[PSID1976$participation == "yes"],
     log(PSID1976$wage[PSID1976$participation == "yes"],
     col = "red", main = log(wage) vs education",
     xlab = "education (years of schooling)",
     ylab = "log(wage)")
     
abline(model2)

# model 3
model3 <- lm(education  ~ feducation,
          data = subset(PSID1976, participation == 'yes))
          
summary(model3)

# model 4
model4 <- lm(log(wage) - fitted.values(model3),
    data = subset(PSID1976, participation == "yes"))
summary(model4)

model5 <- ivreg(log(wage) ~ education | feducation,
    data = subset(PSID1976, participation == "yes"))
summary(model5)

library(devtools)

# observe a variable, the instrument, that is correlated with the outcome variable
# assume that instrument does not have a causal effect on the treatment variable
# assume that instrument has a causal effect on the treatment
# assume that instrument as if randomly assigned
# b/c instrument assumed to be as if randomly assigned, causal effect of instrument on explanatory variable is their correlation with the data
# since instrument is randomly assigned, it is not correlated with other confounders, except the treatment

# if instrument shows clear correlation with outcome, it is because the treatment did have an effect

# pretreatment variables are fixed before treatment is assigned
# pretreatment variables may be observed and unobserved variables/confounding variables

# instrument - treatment - outcome

# instrument provides an exogenouse source of variation



